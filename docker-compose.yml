version: '3.8'

################################################################################
# OpenClaw Docker Compose Configuration
# 
# Features:
# - gVisor runtime for enhanced isolation
# - Docker Secrets for credential management
# - Security-hardened containers (read-only, no-new-privileges, cap-drop)
# - Resource limits (memory, CPU)
# - Health checks
# - Persistent volumes for config and workspace
# - Isolated network
################################################################################

services:
  openclaw:
    image: openclaw:secure
    container_name: openclaw-gateway
    hostname: openclaw
    
    # gVisor runtime for kernel-level isolation
    # Remove or change to 'runc' if gVisor is not available
    runtime: runsc
    
    # Security configuration
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    
    cap_drop:
      - ALL
    
    # Add only required capabilities
    cap_add:
      - NET_BIND_SERVICE  # For binding to port 18789
    
    # Read-only root filesystem with writable mounts
    read_only: true
    
    # User namespace remapping (non-root)
    user: "1000:1000"
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2048M
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Environment variables
    environment:
      - NODE_ENV=production
      - OPENCLAW_STATE_DIR=/app/config
      - OPENCLAW_WORKSPACE_DIR=/app/workspace
      - OPENCLAW_LOG_DIR=/app/logs
      - OPENCLAW_LOG_LEVEL=info
      
      # LLM Provider Configuration (using Docker Secrets)
      - ANTHROPIC_API_KEY_FILE=/run/secrets/anthropic_api_key
      - OPENAI_API_KEY_FILE=/run/secrets/openai_api_key
      - GOOGLE_API_KEY_FILE=/run/secrets/google_api_key
      
      # Telegram Bot Configuration
      - TELEGRAM_BOT_TOKEN_FILE=/run/secrets/telegram_bot_token
      
      # Security settings
      - OPENCLAW_SECURITY_PAIRING_MODE=true
      - OPENCLAW_SECURITY_REQUIRE_MENTION=true
      
    # Docker Secrets
    secrets:
      - anthropic_api_key
      - openai_api_key
      - google_api_key
      - telegram_bot_token
    
    # Port mapping
    ports:
      - "127.0.0.1:18789:18789"  # Bind to localhost only for security
    
    # Volumes
    volumes:
      # Configuration (persistent)
      - openclaw-config:/app/config:rw
      
      # Workspace (persistent)
      - openclaw-workspace:/app/workspace:rw
      
      # Logs (persistent)
      - openclaw-logs:/app/logs:rw
      
      # Temporary directory (tmpfs for security)
      - type: tmpfs
        target: /app/tmp
        tmpfs:
          size: 104857600  # 100MB
          mode: 1777
      
      # Additional tmpfs mounts for runtime
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 104857600  # 100MB
          mode: 1777
    
    # Networks
    networks:
      - openclaw-net
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=openclaw,environment=production"

  # Optional: OpenClaw CLI companion service for maintenance
  openclaw-cli:
    image: openclaw:secure
    container_name: openclaw-cli
    
    # Same security settings as main service
    runtime: runsc
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    user: "1000:1000"
    
    # Share volumes with main service
    volumes:
      - openclaw-config:/app/config:rw
      - openclaw-workspace:/app/workspace:rw
      - openclaw-logs:/app/logs:ro  # Read-only for logs
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 52428800  # 50MB
    
    secrets:
      - anthropic_api_key
      - openai_api_key
      - google_api_key
      - telegram_bot_token
    
    networks:
      - openclaw-net
    
    # CLI service runs on-demand, not continuously
    profiles:
      - cli
    
    # Override entrypoint for interactive use
    entrypoint: ["/usr/bin/tini", "--"]
    command: ["bash"]
    
    stdin_open: true
    tty: true

################################################################################
# Docker Secrets
################################################################################
secrets:
  anthropic_api_key:
    file: ./secrets/anthropic_api_key.txt
  
  openai_api_key:
    file: ./secrets/openai_api_key.txt
  
  google_api_key:
    file: ./secrets/google_api_key.txt
  
  telegram_bot_token:
    file: ./secrets/telegram_bot_token.txt

################################################################################
# Volumes
################################################################################
volumes:
  openclaw-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${OPENCLAW_CONFIG_DIR:-./config}
  
  openclaw-workspace:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${OPENCLAW_WORKSPACE_DIR:-./workspace}
  
  openclaw-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${OPENCLAW_LOG_DIR:-./logs}

################################################################################
# Networks
################################################################################
networks:
  openclaw-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
    driver_opts:
      com.docker.network.bridge.name: openclaw0
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"

################################################################################
# Usage:
################################################################################
# Start OpenClaw:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f
#
# Stop OpenClaw:
#   docker compose down
#
# Run CLI commands:
#   docker compose run --rm openclaw-cli openclaw status
#
# Interactive shell:
#   docker compose --profile cli run --rm openclaw-cli
#
# Rebuild after changes:
#   docker compose build
#   docker compose up -d
#
# Check health:
#   docker compose ps
#
# Update secrets (zero-downtime):
#   ./rotate-secrets.sh
################################################################################
